# ç½‘ç«™è®¿é—®ç»Ÿè®¡ç³»ç»Ÿ - åç«¯æœåŠ¡å™¨

è¿™æ˜¯ä¸€ä¸ªåŸºäº Node.js + Express + MySQL çš„ç½‘ç«™è®¿é—®ç»Ÿè®¡ç³»ç»Ÿï¼Œç”¨äºè®°å½•å’Œåˆ†æç½‘ç«™è®¿é—®æ•°æ®ã€‚

## ğŸš€ åŠŸèƒ½ç‰¹æ€§

- **å®æ—¶è®¿é—®è®°å½•**: è‡ªåŠ¨è®°å½•æ¯ä¸ªé¡µé¢çš„è®¿é—®æƒ…å†µ
- **è®¿é—®ç»Ÿè®¡**: æ€»è®¿é—®é‡ã€ä»Šæ—¥è®¿é—®ã€æœ¬å‘¨è®¿é—®ã€ç‹¬ç«‹è®¿å®¢ç­‰
- **çƒ­é—¨é¡µé¢æ’è¡Œ**: æŒ‰è®¿é—®é‡æ’åºçš„é¡µé¢æ’è¡Œæ¦œ
- **è®¿é—®è¶‹åŠ¿åˆ†æ**: æœ€è¿‘7å¤©çš„è®¿é—®è¶‹åŠ¿å›¾è¡¨
- **æ•°æ®æŒä¹…åŒ–**: ä½¿ç”¨MySQLæ•°æ®åº“å­˜å‚¨æ‰€æœ‰ç»Ÿè®¡æ•°æ®
- **APIæ¥å£**: æä¾›å®Œæ•´çš„RESTful APIæ¥å£
- **å®‰å…¨é˜²æŠ¤**: åŒ…å«è¯·æ±‚é™åˆ¶ã€CORSé…ç½®ç­‰å®‰å…¨æªæ–½

## ğŸ“‹ ç³»ç»Ÿè¦æ±‚

- Node.js >= 18.0.0
- MySQL >= 5.7 æˆ– MariaDB >= 10.3
- npm >= 8.0.0

## ğŸ› ï¸ å®‰è£…æ­¥éª¤

### 1. å…‹éš†é¡¹ç›®
```bash
git clone <your-repo-url>
cd server
```

### 2. å®‰è£…ä¾èµ–
```bash
npm install
```

### 3. é…ç½®ç¯å¢ƒå˜é‡
å¤åˆ¶ `env.example` æ–‡ä»¶ä¸º `.env` å¹¶ä¿®æ”¹é…ç½®ï¼š
```bash
cp env.example .env
```

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼š
```env
# æ•°æ®åº“é…ç½®
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=toolbox_stats
DB_PORT=3306

# æœåŠ¡å™¨é…ç½®
PORT=3001
NODE_ENV=development

# å®‰å…¨é…ç½®
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100

# ç®¡ç†APIå¯†é’¥ï¼ˆå¯é€‰ï¼‰
ADMIN_API_KEY=your_secret_key_here
```

### 4. åˆ›å»ºæ•°æ®åº“
```bash
mysql -u root -p < init-db.sql
```

æˆ–è€…æ‰‹åŠ¨æ‰§è¡ŒSQLè„šæœ¬ï¼š
```sql
CREATE DATABASE toolbox_stats CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

### 5. å¯åŠ¨æœåŠ¡å™¨
```bash
# å¼€å‘æ¨¡å¼
npm run dev

# ç”Ÿäº§æ¨¡å¼
npm start
```

## ğŸ—„ï¸ æ•°æ®åº“ç»“æ„

### ä¸»è¦æ•°æ®è¡¨

1. **visitor_stats**: è®¿é—®è®°å½•è¯¦æƒ…
   - é¡µé¢URLã€è®¿é—®è€…IPã€ç”¨æˆ·ä»£ç†ã€æ¥æºé¡µé¢ã€è®¿é—®æ—¶é—´

2. **page_summary**: é¡µé¢ç»Ÿè®¡æ±‡æ€»
   - é¡µé¢URLã€æ€»è®¿é—®é‡ã€ç‹¬ç«‹è®¿å®¢æ•°ã€æœ€åæ›´æ–°æ—¶é—´

3. **daily_stats**: æ¯æ—¥è®¿é—®ç»Ÿè®¡
   - æ—¥æœŸã€é¡µé¢URLã€å½“æ—¥è®¿é—®é‡ã€å½“æ—¥ç‹¬ç«‹è®¿å®¢æ•°

## ğŸ”Œ APIæ¥å£

### åŸºç¡€URL
```
http://localhost:3001/api
```

### æ¥å£åˆ—è¡¨

#### 1. è®°å½•é¡µé¢è®¿é—®
```
POST /api/visit
Content-Type: application/json

{
  "pageUrl": "/home"
}
```

#### 2. è·å–é¡µé¢ç»Ÿè®¡
```
GET /api/stats/page/:pageUrl

ä¾‹å¦‚: GET /api/stats/page/home
```

#### 3. è·å–æ€»ä½“ç»Ÿè®¡
```
GET /api/stats/overall
```

#### 4. è·å–çƒ­é—¨é¡µé¢æ’è¡Œ
```
GET /api/stats/top-pages?limit=10
```

#### 5. è·å–è®¿é—®è¶‹åŠ¿
```
GET /api/stats/trend?days=7
```

#### 6. æ¸…ç†æ—§æ•°æ®ï¼ˆéœ€è¦APIå¯†é’¥ï¼‰
```
POST /api/admin/cleanup
Headers: x-api-key: your_secret_key
```

## ğŸ”§ é…ç½®è¯´æ˜

### æ•°æ®åº“è¿æ¥é…ç½®
- `DB_HOST`: æ•°æ®åº“ä¸»æœºåœ°å€
- `DB_USER`: æ•°æ®åº“ç”¨æˆ·å
- `DB_PASSWORD`: æ•°æ®åº“å¯†ç 
- `DB_NAME`: æ•°æ®åº“åç§°
- `DB_PORT`: æ•°æ®åº“ç«¯å£

### æœåŠ¡å™¨é…ç½®
- `PORT`: æœåŠ¡å™¨ç›‘å¬ç«¯å£
- `NODE_ENV`: è¿è¡Œç¯å¢ƒï¼ˆdevelopment/productionï¼‰

### å®‰å…¨é…ç½®
- `RATE_LIMIT_WINDOW_MS`: è¯·æ±‚é™åˆ¶æ—¶é—´çª—å£ï¼ˆæ¯«ç§’ï¼‰
- `RATE_LIMIT_MAX_REQUESTS`: æ—¶é—´çª—å£å†…æœ€å¤§è¯·æ±‚æ•°
- `ADMIN_API_KEY`: ç®¡ç†æ¥å£çš„APIå¯†é’¥

## ğŸ“Š æ•°æ®ç»Ÿè®¡é€»è¾‘

### è®¿é—®é‡ç»Ÿè®¡
- æ¯æ¬¡é¡µé¢è®¿é—®éƒ½ä¼šå¢åŠ æ€»è®¿é—®é‡
- æ”¯æŒé‡å¤è®¿é—®ç»Ÿè®¡

### ç‹¬ç«‹è®¿å®¢ç»Ÿè®¡
- åŸºäºIPåœ°å€è¯†åˆ«ç‹¬ç«‹è®¿å®¢
- 24å°æ—¶å†…åŒä¸€IPè®¿é—®åŒä¸€é¡µé¢åªè®¡ç®—ä¸€æ¬¡

### æ•°æ®æ¸…ç†
- è‡ªåŠ¨æ¸…ç†90å¤©å‰çš„è®¿é—®è®°å½•
- æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œæ¸…ç†ä»»åŠ¡

## ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

### 1. ä½¿ç”¨PM2ç®¡ç†è¿›ç¨‹
```bash
npm install -g pm2
pm2 start server.js --name "visitor-counter"
pm2 save
pm2 startup
```

### 2. ä½¿ç”¨Nginxåå‘ä»£ç†
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://localhost:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

### 3. ä½¿ç”¨Dockeréƒ¨ç½²
```bash
# æ„å»ºé•œåƒ
docker build -t visitor-counter .

# è¿è¡Œå®¹å™¨
docker run -d \
  --name visitor-counter \
  -p 3001:3001 \
  --env-file .env \
  --restart unless-stopped \
  visitor-counter
```

## ğŸ” ç›‘æ§å’Œæ—¥å¿—

### å¥åº·æ£€æŸ¥
```
GET /health
```

### æ—¥å¿—è®°å½•
- è®¿é—®è®°å½•æ—¥å¿—
- é”™è¯¯æ—¥å¿—
- æ€§èƒ½ç›‘æ§æ—¥å¿—

## ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§

- **è¯·æ±‚é™åˆ¶**: é˜²æ­¢APIæ»¥ç”¨
- **CORSé…ç½®**: æ§åˆ¶è·¨åŸŸè®¿é—®
- **Helmet**: å®‰å…¨å¤´è®¾ç½®
- **è¾“å…¥éªŒè¯**: å‚æ•°éªŒè¯å’Œæ¸…ç†
- **é”™è¯¯å¤„ç†**: å®‰å…¨çš„é”™è¯¯å“åº”

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

- **è¿æ¥æ± **: MySQLè¿æ¥æ± ç®¡ç†
- **ç´¢å¼•ä¼˜åŒ–**: æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
- **ç¼“å­˜ç­–ç•¥**: å‡å°‘é‡å¤æŸ¥è¯¢
- **å¼‚æ­¥å¤„ç†**: éé˜»å¡I/Oæ“ä½œ

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ•°æ®åº“è¿æ¥å¤±è´¥**
   - æ£€æŸ¥æ•°æ®åº“æœåŠ¡æ˜¯å¦å¯åŠ¨
   - éªŒè¯è¿æ¥å‚æ•°æ˜¯å¦æ­£ç¡®
   - ç¡®è®¤æ•°æ®åº“ç”¨æˆ·æƒé™

2. **APIè¯·æ±‚å¤±è´¥**
   - æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ
   - éªŒè¯APIåœ°å€å’Œç«¯å£
   - æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—

3. **ç»Ÿè®¡æ•°æ®ä¸å‡†ç¡®**
   - æ£€æŸ¥æ•°æ®æ¸…ç†ä»»åŠ¡æ˜¯å¦æ­£å¸¸
   - éªŒè¯ç»Ÿè®¡é€»è¾‘æ˜¯å¦æ­£ç¡®
   - æŸ¥çœ‹æ•°æ®åº“è¡¨ç»“æ„

### æ—¥å¿—æŸ¥çœ‹
```bash
# æŸ¥çœ‹PM2æ—¥å¿—
pm2 logs visitor-counter

# æŸ¥çœ‹Dockeræ—¥å¿—
docker logs visitor-counter
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. æœåŠ¡å™¨æ—¥å¿—
2. æ•°æ®åº“è¿æ¥çŠ¶æ€
3. ç¯å¢ƒå˜é‡é…ç½®
4. ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è®¾ç½®

## ğŸ“„ è®¸å¯è¯

MIT License
